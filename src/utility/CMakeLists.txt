cmake_minimum_required(VERSION 3.25)
project(utility)

find_package(OpenCV REQUIRED)
# Generate FlatBuffers C++ headers from .fbs files so Time_generated.h exists
find_program(FLATC_EXECUTABLE flatc)
if(NOT FLATC_EXECUTABLE)
	message(STATUS "flatc not found in PATH. FlatBuffers C++ headers will NOT be generated automatically. Install flatc or add it to PATH to enable generation.")
else()
	file(GLOB FLATBUFFERS_SCHEMAS ${CMAKE_SOURCE_DIR}/config/flatbuffers/*.fbs)
	set(FLATBUFFERS_OUT_DIR ${CMAKE_SOURCE_DIR}/config/autogenerated_flatbuffers)
	file(MAKE_DIRECTORY ${FLATBUFFERS_OUT_DIR})

	set(FLATBUFFERS_GENERATED_FILES)
	foreach(SCHEMA ${FLATBUFFERS_SCHEMAS})
		get_filename_component(SCHEMA_NAME ${SCHEMA} NAME_WE)
		list(APPEND FLATBUFFERS_GENERATED_FILES
			${FLATBUFFERS_OUT_DIR}/${SCHEMA_NAME}_generated.h
			${FLATBUFFERS_OUT_DIR}/${SCHEMA_NAME}.bfbs
		)
		add_custom_command(
			OUTPUT ${FLATBUFFERS_OUT_DIR}/${SCHEMA_NAME}_generated.h ${FLATBUFFERS_OUT_DIR}/${SCHEMA_NAME}.bfbs
			COMMAND ${FLATC_EXECUTABLE} -c -b -o ${FLATBUFFERS_OUT_DIR} ${SCHEMA}
			DEPENDS ${SCHEMA}
			COMMENT "Generating FlatBuffers C++ and binary schema for ${SCHEMA_NAME}"
			VERBATIM
		)
	endforeach()

	add_custom_target(flatbuffers_generated_schemas DEPENDS ${FLATBUFFERS_GENERATED_FILES})
endif()
#
file(GLOB_RECURSE ${PROJECT_NAME}_src ${CMAKE_CURRENT_SOURCE_DIR}/src/*.cpp ${CMAKE_CURRENT_SOURCE_DIR}/src/*.c)

add_library(${PROJECT_NAME} OBJECT ${${PROJECT_NAME}_src})
if(TARGET flatbuffers_generated_schemas)
	add_dependencies(${PROJECT_NAME} flatbuffers_generated_schemas)
endif()

target_compile_features(${PROJECT_NAME} PUBLIC c_std_99 cxx_std_20)

target_link_libraries(${PROJECT_NAME} PUBLIC ${OpenCV_LIBS})

target_include_directories(${PROJECT_NAME} PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/inc)
target_include_directories(${PROJECT_NAME} PUBLIC ../../config/autogenerated_flatbuffers)
